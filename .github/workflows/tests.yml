name: UI tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install --with-deps

      - name: Run tests
        run: |
          pytest -m regression --alluredir=allure-results -n 2

      # üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–ö–õ–Æ–ß–ï–í–û)
      - name: Debug allure-results
        if: always()
        run: |
          echo "Allure results:"
          ls -la allure-results || true

      # üìú –ó–∞–±–∏—Ä–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
      - name: Get Allure history
        if: always()
        continue-on-error: true
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Restore Allure history
        if: always()
        run: |
          mkdir -p allure-results/history
          if [ -d gh-pages/allure-history ]; then
            cp -r gh-pages/allure-history/* allure-results/history/
          fi

      # ‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Allure CLI
      - name: Install Allure CLI
        run: |
          curl -o allure.tgz -Ls https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          tar -zxvf allure.tgz
          sudo mv allure-2.27.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure

      # üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞
      - name: Generate Allure report
        if: always()
        run: |
          allure generate allure-results -o allure-history --clean

      # üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è
      - name: Deploy report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history
